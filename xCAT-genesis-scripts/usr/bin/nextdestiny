#!/bin/bash
if [ -z "$XCATDEST" ]; then
    XCATDEST=$1
fi
echo "<xcatrequest>
<command>nextdestiny</command>
<callback_port>300</callback_port>
</xcatrequest>" > /tmp/destreq.xml
if [ -f /tmp/destiny.xml ]; then rm /tmp/destiny.xml; fi
timer=0
while [ ! -f /tmp/destiny.xml ]; do
    for((; timer>0; --timer)); do
        echo -en  "No destiny command received, retrying in $timer seconds  \r" >&2
        sleep 1
    done
    echo "                                                         " >&2;
    if [ -f /etc/xcat/cert.pem -a -f /etc/xcat/certkey.pem ]; then #use client cert if available
        SSL_CERT_OPTS=( -key /etc/xcat/certkey.pem -cert /etc/xcat/cert.pem )
    fi
    openssl s_client "${SSL_CERT_OPTS[@]}" -connect "$XCATDEST" -quiet </tmp/destreq.xml 2>/dev/null >/tmp/destiny.xml
    timer=60
done
rm /tmp/destreq.xml
DESTINY="$(awk -F'>' '/<destiny>/{print $2}' /tmp/destiny.xml | awk -F'<' '{print $1}')"
if [ -z "$DESTINY" ]; then
    ERROR="$(awk -F'>' '/<error>/{print $2}' /tmp/destiny.xml |awk -F'<' '{print $1}')"
    DESTINY="error=${ERROR:-No destiny command received}"
fi
rm /tmp/destiny.xml
echo "$DESTINY"
