#!/bin/bash
allowcred.awk &
CREDPID=$!
if [ -z "$XCATDEST" ]; then
	XCATDEST=$1
fi
#retry in case certkey.pem is not right, yet
while ! openssl req -new -key /etc/xcat/certkey.pem -out /tmp/tls.csr -subj "/CN=$(hostname)" >& /dev/null; do
	sleep 1
done
{
  cat <<__HEAD 
<xcatrequest>
  <command>getcredentials</command>
  <arg>x509cert</arg>
  <callback_port>300</callback_port>
  <csr>
__HEAD 
  cat /tmp/tls.csr
  cat <<__FOOT
  </csr>
  <sha512sig>
  </sha512sig>
</xcatrequest>
__FOOT
} > /tmp/certreq.xml
openssl dgst -sha512 -out /tmp/certreq.sha512 -sign /etc/xcat/privkey.pem /tmp/certreq.xml #chain off the switch published key
openssl enc -e -a -in /tmp/certreq.sha512  > /tmp/certreq.b64sig
sed -i "/^<sha512sig>$/ r /tmp/certreq.b64sig" /tmp/certreq.xml
openssl s_client -connect "$XCATDEST" -quiet </tmp/certreq.xml 2>/dev/null >/tmp/certresp.xml
if grep -q 'BEGIN CERTIFICATE' /tmp/certresp.xml ; then
    awk '/BEGIN CERTIFICATE/,/END CERTIFICATE/' < /tmp/certresp.xml > /etc/xcat/cert.pem
    #stop transmitting sysDesc, allowing the public key to age out of validity
    while read -r iface ; do
        lldptool -T -i "$iface" -V sysDesc enableTx=no >& /dev/null
    done < <(awk '/^  e/{print $1}' /var/lib/lldpad/lldpad.conf)
fi
rm /tmp/certreq.b64sig /tmp/certreq.sha512
rm /tmp/certreq.xml
rm /tmp/certresp.xml
kill "$CREDPID"
