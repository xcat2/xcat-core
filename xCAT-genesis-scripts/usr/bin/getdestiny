#!/bin/bash
if [ -z "$XCATDEST" ]; then
    XCATDEST="$1"
fi
echo "<xcatrequest>
<command>getdestiny</command>
<callback_port>300</callback_port>
</xcatrequest>" > /tmp/destreq.xml
if [ -f /tmp/destiny.xml ]; then rm /tmp/destiny.xml; fi
while [[ ! -f /tmp/destiny.xml ]] || grep error /tmp/destiny.xml; do
    if [[ -f /tmp/destiny.xml ]]; then
        for ((timer=60; timer>0; --timer)); do
            echo -en  "Retrying in $timer seconds  \r" >&2
            sleep 1
        done
    fi
    echo "                                                         " >&2
    if [ -f /etc/xcat/cert.pem -a -f /etc/xcat/certkey.pem ]; then #use client cert if available
        SSL_CERT_OPTS=( -key /etc/xcat/certkey.pem -cert /etc/xcat/cert.pem )
    fi
    openssl s_client "${SSL_CERT_OPTS[@]}" -connect "$XCATDEST" -quiet </tmp/destreq.xml 2> /dev/null > /tmp/destiny.xml
done
rm /tmp/destreq.xml
DESTINY="$(awk -F'>' '/<destiny>/{print $2}' /tmp/destiny.xml|awk -F'<' '{print $1}')"
rm /tmp/destiny.xml
echo "$DESTINY"

