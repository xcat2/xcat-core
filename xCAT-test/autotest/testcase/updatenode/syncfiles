#!/bin/bash

set -x

COMPUTE_NODE="${1:?empty compute node}"

OSIMAGE="$(lsdef "${COMPUTE_NODE}" -i provmethod | awk -F = '/provmethod=/ { print $2 }')"

TMP_DIR="$(mktemp -d "/tmp/${0##*/}.XXXXXXXX" 2>/dev/null)"

function cleanup()
{
	rm -rf "${TMP_DIR}"
	chdef -t osimage "${OSIMAGE}" "synclists="
}

trap cleanup EXIT

function compute_node_cleanup()
{
	xdsh "${COMPUTE_NODE}" "rm -rf /etc/files"
}

declare -i failed=0

mkdir -p "${TMP_DIR}/files"
echo foo >"${TMP_DIR}/files/foo"
echo bar >"${TMP_DIR}/files/bar"
echo baz >"${TMP_DIR}/files/baz"

cat >"${TMP_DIR}/foobar.synclist" <<EOF
${TMP_DIR}/files/foo -> /etc/files/foo
${TMP_DIR}/files/bar -> /etc/files/bar
${TMP_DIR}/files/baz -> /etc/files/baz
EOF

chdef -t osimage "${OSIMAGE}" "synclists=${TMP_DIR}/foobar.synclist"

updatenode "${COMPUTE_NODE}" -F
# Check return code
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep foo /etc/files/foo'
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep bar /etc/files/bar'
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep baz /etc/files/baz'
(( failed += $? ))
compute_node_cleanup

updatenode "${COMPUTE_NODE}" -F -r /usr/bin/scp
# Check return code
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep foo /etc/files/foo'
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep bar /etc/files/bar'
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep baz /etc/files/baz'
(( failed += $? ))
compute_node_cleanup

# ====== #

xdsh "${COMPUTE_NODE}" 'mkdir -p /etc/files/bar'
updatenode "${COMPUTE_NODE}" -F
# Check return code
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep foo /etc/files/foo'
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep bar /etc/files/bar'
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep baz /etc/files/baz'
(( failed += $? ))
compute_node_cleanup

xdsh "${COMPUTE_NODE}" 'mkdir -p /etc/files/bar'
updatenode "${COMPUTE_NODE}" -F -r /usr/bin/scp
# Check return code
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep foo /etc/files/foo'
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep bar /etc/files/bar'
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep baz /etc/files/baz'
(( failed += $? ))
compute_node_cleanup

# ====== #

rm -f "${TMP_DIR}/files/bar"

updatenode "${COMPUTE_NODE}" -F
xdsh "${COMPUTE_NODE}" 'grep foo /etc/files/foo'
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep baz /etc/files/baz'
(( failed += $? ))
compute_node_cleanup

updatenode "${COMPUTE_NODE}" -F -r /usr/bin/scp
xdsh "${COMPUTE_NODE}" 'grep foo /etc/files/foo'
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep baz /etc/files/baz'
(( failed += $? ))
compute_node_cleanup

# ====== #

mkdir -p "${TMP_DIR}/files/bar"
xdsh "${COMPUTE_NODE}" 'mkdir -p /etc/files && echo bar >/etc/files/bar'
updatenode "${COMPUTE_NODE}" -F
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep foo /etc/files/foo'
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'test -d /etc/files/bar'
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep baz /etc/files/baz'
(( failed += $? ))
compute_node_cleanup

xdsh "${COMPUTE_NODE}" 'mkdir -p /etc/files && echo bar >/etc/files/bar'
updatenode "${COMPUTE_NODE}" -F -r /usr/bin/scp
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep foo /etc/files/foo'
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'test -d /etc/files/bar'
(( failed += $? ))
xdsh "${COMPUTE_NODE}" 'grep baz /etc/files/baz'
(( failed += $? ))
compute_node_cleanup

exit "${failed}"
